<html>
<head>
<style>
#fullscreenContent {
	width:  100vw;
	height:  100vh;
	z-index: 10;
	position: absolute;
	top: 0;
	left:  0;
	background-color: white;
	text-align: center;
	line-height: 100vh;
	font-size: 5vmin;
}

.controlsHidden {
	width: 210vw !important;
	height: 130vh !important;
	top: -30vh !important;
	left: -50vw !important;
}
body {
	background-color: black;
}
#player {
	position: absolute;
	width: 100vw;
	height: 100vh;
	z-index:  11;
}
</style>
<script src="peer.min.js"></script>
<script src="html2canvas.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
<iframe id="miroIframe" src="https://miro.com/app/live-embed/o9J_l-ZMldc=/?moveToViewport=-374,-550,748,1100" scrolling="no" allowfullscreen="" style="width: 100vw;height: 100vh;position: absolute;top: 0px;left: 0px;" frameborder="0"></iframe>

<div id="fullscreenContent">click to begin. Music: www.bensound.com</div>
<div id="player" style="display:none;"></div>

<script type="text/javascript">
document.getElementById("fullscreenContent").onclick = function(e) {
	let el = e.target;
	e.target.style.display = "none";
}

let player;
// init player
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    // height: '200',
    // width: '300',
    videoId: 'dQw4w9WgXcQ',
    events: {
      'onReady': onPlayerReady
    },

    playerVars: { 
        'autoplay': 0,
        'controls': 0, 
        'rel' : 0,
        'fs' : 0,
    }
  });
}


// when ready, wait for clicks
function onPlayerReady(event) {
  var player = event.target;
  // iframe = $('#player');
  // setupListener(); 
}

var peer = new Peer();
peer.on('error', console.log);
let controllerId = "work-aaron-project_immerse_controller";

peer.on("open", function() {
	console.log("started");
	var conn = peer.connect(controllerId);

	conn.on('open', function() {
	  // Receive messages
	  conn.on('data', function(data) {
	  	if (data == "playSound") {
			var audio = new Audio('bensound-betterdays.mp3');
			audio.play();
			audio.currentTime = 3;
	  	}
	  	else if (data == "outroEffect") {
			html2canvas(document.querySelector("#miroIframe")).then(canvas => {
			    document.body.appendChild(canvas)
			});
	  	}
	  	else if (data == "screenShakeEffect") {
	  		let shakeTime = 2;
	  		let shakeTranslateAmount = 10;
	  		let shakeRotateAmount = 3;

	  		let shakeStart = Date.now();
	  		let shakeFunc = function() {
		  			let timeSinceStart = (Date.now() - shakeStart) / 1000;
		  			let shakeFactor = (shakeTime - timeSinceStart)/shakeTime;
		  			if (timeSinceStart < shakeTime) {
			  			requestAnimationFrame(shakeFunc);
			  		}
			  		else {
			  			shakeFactor = 0;
			  		}
		  			document.getElementById("miroIframe").style.transform = 
			  				"translate("
			  			 + (Math.random() * shakeTranslateAmount - shakeTranslateAmount/2) * shakeFactor + "px, "
			  			 + (Math.random() * shakeTranslateAmount - shakeTranslateAmount/2) * shakeFactor + "px) rotate("
			  			 + (Math.random() * shakeRotateAmount - shakeRotateAmount/2) * shakeFactor + "deg)";
	  		}
		  	shakeFunc();
	  	}
	  	else if (data == "playVideo") {
	  		document.querySelector("#player").style.display = "";
	  		player.playVideo();
	  	}
	  	else if (data == "hideVideo") {
	  		document.querySelector("#player").style.display = "none";
	  		player.stopVideo();
	  	}
	  	else if (data == "hideControls") {
	  		document.querySelector("#miroIframe").classList.add("controlsHidden");
	  	}
	  	else if (data == "showControls") {
	  		document.querySelector("#miroIframe").classList.remove("controlsHidden");
	  	}
	    console.log('Received', data);
	  	conn.send('Hello!');
	  });

	  // Send messages
	  conn.send('Hello!');
	});
});


</script>
</body>
</html>